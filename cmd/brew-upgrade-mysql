#!/bin/bash

set -e

upgrade_mysql() {
  echo "Running mysql_upgrade..."

  local exitstatus=0
  # Hide failures from "already upgraded", otherwise let it bubble up
  if ! output=$($(brew --prefix mysql@5.7)/bin/mysql_upgrade -u root); then
    exitstatus="$?"
    if echo "$output" | grep --quiet "already upgraded"; then
      exitstatus=0
    else
      # If there's some other reason for this, we want to make sure it's heard
      echo "$output"
    fi
  fi

  return $exitstatus
}

update_my_cnf() {
  CNF_PATH="$(brew --prefix)/etc/my.cnf"

  touch $CNF_PATH

  echo "Backing up old my.cnf file..."
  cp -vf $CNF_PATH "$CNF_PATH.github"

  cat > $CNF_PATH <<-EOM
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html

[mysqld]

innodb_strict_mode=OFF
optimizer_switch='index_merge_intersection=OFF'
query_cache_size=0
sql_mode=NO_ENGINE_SUBSTITUTION
EOM
}

mysql_stop() {
  brew services stop $1 || true
  while ! [[ "$(pgrep mysqld)" == "" ]]; do
    echo "Waiting for MySQL to shut down ..." 
    sleep 2
  done
}

mysql_start() {
  brew services start $1
  while ! $(brew --prefix "$1")/bin/mysqladmin ping --silent; do
    echo "Waiting for MySQL to be available..."
    sleep 2
  done
}

if [[ -d $(brew --prefix mysql@5.6) || -d $(brew --prefix mysql@5.7) ]]; then
  if [[ -d $(brew --prefix mysql@5.6) ]]; then
    mysql_stop "mysql@5.6"

    brew install mysql@5.7
  fi

  mysql_stop "mysql@5.7"

  update_my_cnf

  mysql_start "mysql@5.7"


  upgraded=$(upgrade_mysql)

  if [[ $upgraded -eq 0 ]]; then
    mysql_stop "mysql@5.7"
    mysql_start "mysql@5.7"
  fi
fi

exit 0
